x) Lue/katso/kuuntele ja tiivistä. (Tässä x-alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen tai kuunteleminen ja tiivistelmä riittää. Tiivistämiseen riittää muutama ranskalainen viiva.)

  OWASP: OWASP Top 10: A01 Broken Access Control
  - Hyökkääjä/käyttäjä tekee jotain mihin hänellä ei pitäisi olla oikeus
  - Yksinkertaisimmillaan hyökkäys johtuu siitä, että tekijä ei ole rajannut oikeuksia tarpeeksi. Esim. Hyökkääjä voi kirjoittaa sivun URL:iin jotain joka vie kielletylle/salaiselle sivulle.
  Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
    - Fuff työkalulla voidaan löytää piilotettu tai salaisia sivuja testamalla tuhansia eri URL:lliä
    - Haluttuja sivuja voidaan löytää tarkastelemalla fuffin antamia tietoja kuten Status, Size,  Words,  Lines, ja Duration 
        
  PortSwigger: Access control vulnerabilities and privilege escalation
   - Pääsynhallinta ( Access control) asettaa rajat kenelle on pääsy mihin.
   - Jos pääsynhallinnassa on aukkoja (Broken access control), sitä voi hyväksikäyttää, nostaa käyttäjän oikeuksia (privilige escalation) ja  päästä käsiksi tietoihin mihin ei ole lupaa. 
        
 Karvinen 2006: Raportin kirjoittaminen
 - Täsmällinen raportointi: selkeät vaiheet, ympäristö, työkalut, lähteiden käyttö ja viittaus,
 - Ei saa sepittää (väittää tehneensä jotain mitä ei ole tehnyt), plagoida toisen tekstin kopioiminen tai käyttäminen ilman että selkeästi ilmoittaa asiasta tai täyttää luvatta muiden kuvia. Nämä kaikki on vilppiä ja ei sallittua!
        
   Vapaaehtoinen: PortSwigger 2020: What is SQL injection? - Web Security Academy (noin 10 min video)
   - SQL-injektio on hyökkäys missä sovellus ei osaa eroittaa tekstin ja koodin eroa
   - Siinä siis syötetään SQL-komento tekstikenttää ja se erheellisesti ajaa komennon, jonka se luulee olevansa vain tekstiä.
  
https://cdimage.debian.org/debian-cd/current/amd64/iso-dvd/         
a) Murtaudu 010-staff-only. Ks. Karvinen 2024: Hack'n Fix

Ensiksi asensin debian 13 bookwormin näiden ohjeiden mukaan: https://terokarvinen.com/2021/install-debian-on-virtualbox/

    sudo apt-get update
    sudo apt-get -y install wget unzip micro
    wget https://terokarvinen.com/hack-n-fix/teros-challenges.zip
    unzip teros-challenges.zip

Sen jälkeen

     cd challenges/010-staff-only/
    sudo apt-get install python3-flask
    sudo apt-get -y install python3-flask python3-flask-sqlalchemy
    python3 staff-only.py
Jonka jälkeen pääsin tänne


<img width="1073" height="142" alt="hfix1" src="https://github.com/user-attachments/assets/072da87d-6755-49c1-a4bc-2c7fd71f48d8" />

Tehtävän tavoite on saada admin salasana. Siinä tiedetään olevan "SUPERADMIN". Lisäksi kohde ystävällisesti tarjoaa kertauksen SQL-syntaksiin


    SELECT password FROM pins WHERE pin='0';

  Tämä hakee salasanat joiden arvo on nolla kohdasta pins

  Ensimmäinen idea joka tuli mieleen on muuttaa sitä, jotta ottaa salasanat jotka sisältää SUPERADMIN, koska sen tiedetään olevan siinä.


     SELECT password FROM pins WHERE pin='SUPERADMIN';





  <img width="1228" height="316" alt="Image" src="https://github.com/user-attachments/assets/04c5a014-ad35-4ca2-b535-9a1df864c0c7" />

  Se ei toiminut, koska sen pitää sisältää numeron. Tämä antaa lisää dataa.

  Muita tietoja on, että oma kuvitteellinen pin on 123 

  <img width="1257" height="355" alt="Image" src="https://github.com/user-attachments/assets/33952f59-1307-4545-9b84-8b96ba51a73d" />

Kokeilemalla varmistin, että se on siellä

Tiedän nyt, että oma pin (somedude) ja admin (SUPERADMIN) salasanat ovat tietokannassa. 

Seuraavaksi päätin kokeilla hakea jompaa kumpaa salasanaa käyttämällä SQL komentoja 

<img width="1245" height="333" alt="Image" src="https://github.com/user-attachments/assets/ce5c7f87-7713-43d9-8077-9638bd27e60c" />

Jälleen herjaa vain numeroita.

Mitä jos numero rajoituksen poistaisi


<img width="390" height="89" alt="number" src="https://github.com/user-attachments/assets/cda1a523-ca52-4fc3-a904-917284429e77" />

Vaihdoin 

    <input type = "number">

  Ja kokeilin: se ei tientenkään toiminut.

  Päätin lopettaa siltä päivältä koska kello oli aivan liian paljon. Aioin mennä nukkumaan ja tutustua johdantotehtäviin huomenna.


Uusi päivä uudet kujeet. Tutustuin johdantotehtäviin. Yhteisenä teemana mitä huomasin on, että   SELECT password FROM pins WHERE pin='SUPERADMIN'; on väärin , koska se on komento, joka suoritetaan kun salasanaa haetaan. Eli sen loppuun pitää syöttää SQL-komento joten oikea tapa on 


    SELECT * FROM passwords  WHERE pin

  Sen loppuun pitää syöttää itse oikea sql-injektio

  <img width="1072" height="107" alt="Image" src="https://github.com/user-attachments/assets/cfda0dac-a12b-40db-aeb9-e3c145706cb8" />

Kokeilin seuraavaksi tämän logiikan tyyliin


<img width="783" height="261" alt="Image" src="https://github.com/user-attachments/assets/9853bd74-dde9-4721-8903-eb4ac3d1cb83" />

Vaihdoin myös inspect työkalulla 

     <input type = "">



Siitä tuli internal server error

<img width="1208" height="180" alt="kuva" src="https://github.com/user-attachments/assets/5dd8f3bc-6a7e-4ffb-8852-1264b046362a" />


Vaikka tämä ei toiminut, paljastui, että sivu on haavoittuvainen sql-injektiolle. Eli nyt ollaan oikeilla jäljillä. 

Tässä vaiheessa katsoin vinkkejä ja myös tajusin, että SUPERADMIN ei välttämättä ole oleellinen tieto tehtävän ratkaisemiseen vaan metatietoa, jotta tietää, että on saanut oikean ratkaisun.

Tämä on mitä taustalla tapahtuu kun hakee pin:in. 


    SELECT password FROM pins WHERE pins

Portswiggeria katselleni näin listan eri esimerkki injectioista. Sopivin näistä vaikutti olevin UNION, koska sivulla luki näin

<img width="1014" height="201" alt="Image" src="https://github.com/user-attachments/assets/5e7ef64c-2548-417d-9420-4e1bee1bcbd2" />

Testasin kuinka monta riviä: 

    ' UNION SELECT NULL--

  Palautti 

  <img width="1229" height="308" alt="Image" src="https://github.com/user-attachments/assets/e65e24da-a539-49f5-bd4d-8b89e41c6132" />


  ja 

    ' UNION SELECT NULL, NULL--
    ' UNION SELECT NULL, NULL, NULL--

  Johtivat internal server error eli rivejä on yksi. Käytin siis tässä tapauksessa 

      ' UNION SELECT NULL--
  

Muokkaisin sen tehtävään sopivaksi: 

Nykyinen haku normaalisti

    SELECT password FROM pins WHERE pins = '

lisätty injectio 

    ' UNION SELECT password FROM pins--';

Lopputulos tietokannassa: 

     SELECT password FROM pins WHERE pins = '' UNION SELECT password FROM pins--';


Sain lipun 
<img width="1300" height="509" alt="kuva" src="https://github.com/user-attachments/assets/118bbae8-e251-4885-87e6-e929a7de5363" />



  

https://portswigger.net/web-security/sql-injection#sql-injection-examples

    


    






b) Korjaa 010-staff-only haavoittuvuus lähdekoodista. Osoita testillä, että ratkaisusi toimii.





Ongelma on, että käyttäjän syötettä ei sanitoida ennen kun se menee tietokantaan. Joten, hain netistä " how to sanitize sql input" ja löysin https://www.esecurityplanet.com/endpoint/prevent-web-attacks-using-input-sanitization/. Sieltä oli sopiva kohta: "Use Prepared Statements for Database Queries: Avoid directly inserting user inputs into SQL queries. Instead, use prepared statements with bound parameters to prevent SQL injection attacks. This way, inputs are treated as data, not executable code."



käytin 

    cat staff-only.py

  Sieltä näkyy miten asiat pyöriin.


      micro staff-only.py

Ja sitten muokkaanmaan. 

Googlasin myös "sqlalchemy sql injection", koska tehtävässä käytetään sitä. 

https://realpython.com/prevent-python-sql-injection/#crafting-safe-query-parameters

Artikkelissä on esimerkki 


    {

            'username': username

        }

  eli 

      {'username':username}
  pin muuttujan pitää olla 'pin':pin

  vanhassa koodissa se konkatenoi ne ja ajaa ne suoraan

  uudessa se osaa erottaa tekstin ja koodin eron ja ei aja käyttäjän syötettä suoraan.


  

  Artikkelissä myös annettaan huonoja esimerkkejä, jossa yksi on 


  <img width="857" height="116" alt="kuva" src="https://github.com/user-attachments/assets/61e40b55-a641-40be-881c-f49f36fd317f" />

joka on sama mitä tehtävässä käytetään.


Korjasin sen näin

<img width="606" height="174" alt="kuva" src="https://github.com/user-attachments/assets/24bbe92c-f48d-4e01-8968-b7488723eb79" />


Testasin 
<img width="1259" height="669" alt="kuva" src="https://github.com/user-attachments/assets/1f5a3776-7530-4349-a870-9357ac076c43" />

ja se on korjattu




c) Ratkaise dirfuzt-1 artikkelista Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf. Tämä auttaa 020-your-eyes-only ratkaisemisessa.
asensin fuffin 

    wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0

    chmod u+x dirfuzt-0
    ./dirfuzt-0

    wget https://github.com/ffuf/ffuf/releases/download/v2.0.0/ffuf_2.0.0_linux_amd64.tar.gz
    tar -xf ffuf_2.0.0_linux_amd64.tar.gz

Ja tein esimerkki tehtävän joka löytyi lisäämällä parametrejä 

    ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
    ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132

  <img width="734" height="352" alt="kuva" src="https://github.com/user-attachments/assets/03e5c736-883a-4899-a29c-cd3bec27db83" />

Siirryin seuraavan tehtävään seuraten samoja askelia.

    wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-1

    chmod u+x dirfuzt-1
    ./dirfuzt-1

Tehtävänä on löytää

Admin page (joku admin)
Version control related page (todennäköisesti jokin git tai .git?)

Kokeilin optimistisesti 

    /ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ

Mutta liikaa tuloksia, pitää rajata. Käytin samaa periaatetta kuin esimerkkitehtävässä: siinä filtteröitiin fs 132, koska se oli yleisin koko. Komento 

     /ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
ei ollut täysin hyödytön, koska se näytti paljon tiedostoja joiden koko oli 154. Joten suodatin ne pois 

    /ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ - fs 154


  Tulokseksi tuli erinäisiä .git sivuja. Laitoin netin takaisin päälle ja lähdin katsommaan. 

  <img width="542" height="225" alt="kuva" src="https://github.com/user-attachments/assets/5345b65a-4390-40d1-bd4f-c96ec7a94272" />

  Ensimmäislle nappasi.

  Seuraavaksi aloin miettimään miten alan etsimään mahdollisia admin sivuja. Kahvitauon pidettyäni huomasin että listan viimesinä oli fuffin löytämä wp-admin. Se   oli outoa, joten testasin 


  <img width="577" height="219" alt="kuva" src="https://github.com/user-attachments/assets/716f907b-4e2b-481e-ab35-6511ffe49306" />

  ja siinähän se oli.




    


d) Murtaudu 020-your-eyes-only. Ks. Karvinen 2024: Hack'n Fix

Käynnistin ympäristön ohjeiden mukaisesti

    cd challenges/020-your-eyes-only/
    sudo apt-get -y install virtualenv
     virtualenv virtualenv/ -p python3 --system-site-packages
     source virtualenv/bin/activate
     cat requirements.txt
  Ei tarpeelista mutta varmuuden vuoksi.

      pip install -r requirements.txt
      cd logtin/
      ./manage.py makemigrations; ./manage.py migrate
      ./manage.py runserver

Otin vm:mmän pois netistä ja ensiksi katsoin ffufilla.

    ./ffuf -w common.txt -u http://127.0.0.1:8000/FUZZ


Sieltä pomppasi esiin admin-console

  <img width="726" height="499" alt="kuva" src="https://github.com/user-attachments/assets/0d02d68b-4583-4a5e-a4d6-ea871853b3bc" />

  

 Tein tilin foo ja kirjauduin sisään. Sen jälkeen kokeilin navigoida admin-console sivulle


 <img width="1298" height="415" alt="kuva" src="https://github.com/user-attachments/assets/1f5030d6-9bf3-4a5f-81b3-942b0777647d" />

 Se toimi!

 
kokeilin login näytöltä kirjoittaa 127.0.0.1/admin-console ja tuli tämä

 <img width="1298" height="415" alt="kuva" src="https://github.com/user-attachments/assets/3bb9da84-7f53-49ae-a84b-8a1f336f0d3c" />

 Se vei salaiselle admin sivulle


 Tämä toimii myös kun tekee saman admin dashboard sivulta.



 

 
 



e) Korjaa 020-your-eyes-only haavoittuvuus. Osoita testillä, että ratkaisusi toimii.

Sovelluksen haavoittuvuus on se että käyttäjää ei autentikoida tarpeeksi . Joten hain lähdekoodista "user" ja "auth". Tiedostosta views.py löytyi 


  <img width="763" height="489" alt="kuva" src="https://github.com/user-attachments/assets/54ce796a-d8db-453f-be16-c7bb1793ee0e" />

  
class AdminDashboardView(UserPassesTestMixin, TemplateView):
    template_name = 'hats/admin_show_all.html'
    def test_func(self):
        return self.request.user.is_authenticated and self.request.user.is_staff

  class AdminShowAllView(UserPassesTestMixin, TemplateView):
    template_name = 'hats/admin_show_all.html'
    def test_func(self):
        return self.request.user.is_authenticated 


  Tässä tapauksessa AdminShowAllView luokassa ei authentikoida test functiossa kuten AdminDashboardView joten se ainakin pitää korjata


  <img width="802" height="188" alt="kuva" src="https://github.com/user-attachments/assets/355a8b7a-5a57-4398-9c83-9ecd3bd0d576" />


  Näin helpolla tämä kyseinen ongelma ratkaistiin

        


g) Vapaaehtoinen. Johdantotehtävä, joka auttaa 010-staff-only ratkaisemisessa. Ratkaise Portswigger Academyn "Lab: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data".
h) Vapaaehtoinen. Johdantotehtävä, joka auttaa 010-staff-only ratkaisemisessa. Ratkaise Portswigger Academyn "Lab: SQL injection vulnerability allowing login bypass"


Lähteet
https://terokarvinen.com/
https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/
https://terokarvinen.com/sovellusten-hakkerointi/#h2-break--unbreak-tero
https://terokarvinen.com/hack-n-fix/
https://portswigger.net/web-security/sql-injection#sql-injection-examples
